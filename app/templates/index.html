<!-- templates/index.html -->
{% extends "base.html" %}

{% block title %}Reddit Search Tool{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-4">
    <!-- Initial Input Section -->
    <div id="initial-section" class="mb-8">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Subreddit Search</h2>
            <div class="flex space-x-4">
                <input type="text" id="initial-input" 
                       class="flex-1 border p-2 rounded" 
                       placeholder="Enter subreddit name (comma-separated for multiple)">
                <button onclick="getSubreddits()" 
                        class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 transition">
                    Load Subreddits
                </button>
            </div>
        </div>
    </div>

    <!-- Selected Subreddits Section -->
    <div id="selected-subreddits" class="mb-8 hidden">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-4">Selected Subreddits:</h3>
            <div id="subreddit-tags" class="flex flex-wrap gap-2"></div>
        </div>
    </div>

    <!-- Search Configuration -->
    <div id="search-config" class="hidden">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4">Search Configuration</h3>
            
            <!-- Time Range -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                    <input type="datetime-local" id="from-time" class="w-full border p-2 rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                    <input type="datetime-local" id="to-time" class="w-full border p-2 rounded">
                </div>
            </div>

            <!-- Sort Types -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Sort Types</label>
                <div class="flex gap-4">
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="sort-type" value="hot" checked>
                        <span class="ml-2">Hot</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="sort-type" value="new" checked>
                        <span class="ml-2">New</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="sort-type" value="top" checked>
                        <span class="ml-2">Top</span>
                    </label>
                </div>
            </div>

            <!-- Posts and Comments Configuration -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Number of Posts</label>
                    <input type="number" id="post-limit" class="w-full border p-2 rounded" 
                           value="100" min="1" max="1000">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Include Comments</label>
                    <select id="include-comments" class="w-full border p-2 rounded">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
            </div>

            <!-- Search Text -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Search Text (Optional)</label>
                <input type="text" id="search-text" class="w-full border p-2 rounded" 
                       placeholder="Enter keywords to filter posts">
            </div>

            <!-- Search Button -->
            <button onclick="performSearch()" 
                    class="w-full bg-green-500 text-white px-6 py-3 rounded hover:bg-green-600 transition">
                Search Posts
            </button>
        </div>
    </div>

    <!-- Results Section -->
    <div id="results" class="mt-8 hidden">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-4">Search Results</h3>
            <div id="results-content" class="p-4 bg-gray-50 rounded"></div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="hidden mt-8">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                <span class="ml-3">Processing search...</span>
            </div>
        </div>
    </div>
</div>

<script>
let selectedSubreddits = [];

function getSubreddits() {
    const input = document.getElementById('initial-input').value;
    if (!input.trim()) {
        showError('Please enter at least one subreddit');
        return;
    }

    selectedSubreddits = input.split(',').map(s => s.trim()).filter(s => s);
    if (selectedSubreddits.length === 0) {
        showError('Please enter valid subreddit names');
        return;
    }

    // Show selected subreddits
    document.getElementById('selected-subreddits').classList.remove('hidden');
    document.getElementById('search-config').classList.remove('hidden');
    renderSubredditTags();
}

function renderSubredditTags() {
    const container = document.getElementById('subreddit-tags');
    container.innerHTML = '';
    
    selectedSubreddits.forEach(subreddit => {
        const tag = document.createElement('div');
        tag.className = 'bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full flex items-center';
        tag.innerHTML = `
            <span>r/${subreddit}</span>
            <button onclick="removeSubreddit('${subreddit}')" 
                    class="ml-2 text-indigo-600 hover:text-indigo-800">Ã—</button>
        `;
        container.appendChild(tag);
    });
}

function removeSubreddit(subreddit) {
    selectedSubreddits = selectedSubreddits.filter(s => s !== subreddit);
    renderSubredditTags();
    if (selectedSubreddits.length === 0) {
        document.getElementById('selected-subreddits').classList.add('hidden');
        document.getElementById('search-config').classList.add('hidden');
    }
}

function getSelectedSortTypes() {
    return Array.from(document.querySelectorAll('.sort-type:checked'))
                .map(checkbox => checkbox.value);
}

function showLoading(show) {
    document.getElementById('loading').classList.toggle('hidden', !show);
    document.getElementById('results').classList.add('hidden');
}

function performSearch() {
    if (selectedSubreddits.length === 0) {
        showError('Please select at least one subreddit');
        return;
    }

    const fromTime = document.getElementById('from-time').value;
    const toTime = document.getElementById('to-time').value;
    
    if (!fromTime || !toTime) {
        showError('Please select both from and to dates');
        return;
    }

    const sortTypes = getSelectedSortTypes();
    if (sortTypes.length === 0) {
        showError('Please select at least one sort type');
        return;
    }

    const searchParams = {
        selected_buttons: selectedSubreddits,
        from_time: fromTime,
        to_time: toTime,
        option1: sortTypes,
        option2: document.getElementById('post-limit').value,
        option3: document.getElementById('include-comments').value,
        search_text: document.getElementById('search-text').value
    };

    showLoading(true);

    fetch('/advanced_search', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(searchParams)
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.status === 'success') {
            showResults(data.results);
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        showLoading(false);
        showError('An error occurred while performing the search');
        console.error('Search error:', error);
    });
}

function showResults(results) {
    const resultsDiv = document.getElementById('results');
    const resultsContent = document.getElementById('results-content');
    resultsDiv.classList.remove('hidden');
    resultsContent.innerHTML = results;
}

function showError(message) {
    const resultsDiv = document.getElementById('results');
    const resultsContent = document.getElementById('results-content');
    resultsDiv.classList.remove('hidden');
    resultsContent.innerHTML = `
        <div class="p-4 bg-red-50 text-red-600 rounded">
            <i class="fas fa-exclamation-circle mr-2"></i>
            ${message}
        </div>
    `;
}

// Set default datetime-local values to current date
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    // Format dates for datetime-local input
    const formatDate = (date) => {
        return date.toISOString().slice(0, 16);
    };
    
    document.getElementById('from-time').value = formatDate(oneWeekAgo);
    document.getElementById('to-time').value = formatDate(now);
});
</script>
{% endblock %}